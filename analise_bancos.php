<?php
/**
 * Script de An√°lise Comparativa dos Bancos de Dados
 * Compara as estruturas entre desenvolvimento e produ√ß√£o
 */

require_once 'app/autoload.php';

class AnaliseBancos
{
    private $dbDev;
    private $dbProd;
    
    public function __construct()
    {
        // Configura√ß√µes de desenvolvimento
        $this->dbDev = new PDO(
            'mysql:host=localhost;port=3306;dbname=meu_framework;charset=utf8mb4',
            'root',
            '',
            [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
        );
        
        // Configura√ß√µes de produ√ß√£o
        $this->dbProd = new PDO(
            'mysql:host=localhost;port=3306;dbname=copare52_chat;charset=utf8mb4',
            'copare52_chat',
            'YiYDW*3vLLKk',
            [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
        );
    }
    
    /**
     * Analisa as diferen√ßas entre os bancos
     */
    public function analisarDiferencas()
    {
        echo "üîç **AN√ÅLISE COMPARATIVA DOS BANCOS DE DADOS**\n\n";
        
        // 1. Verificar tabelas existentes
        $this->verificarTabelas();
        
        // 2. Verificar colunas das tabelas principais
        $this->verificarColunasPrincipais();
        
        // 3. Verificar dados cr√≠ticos
        $this->verificarDadosCriticos();
        
        // 4. Verificar procedimentos e views
        $this->verificarProcedimentosViews();
        
        // 5. Verificar √≠ndices e constraints
        $this->verificarIndicesConstraints();
    }
    
    /**
     * Verifica tabelas existentes em ambos os bancos
     */
    private function verificarTabelas()
    {
        echo "üìã **1. VERIFICA√á√ÉO DE TABELAS**\n";
        echo str_repeat("-", 50) . "\n";
        
        $tabelasDev = $this->getTabelas($this->dbDev);
        $tabelasProd = $this->getTabelas($this->dbProd);
        
        echo "Tabelas em Desenvolvimento (" . count($tabelasDev) . "):\n";
        foreach ($tabelasDev as $tabela) {
            echo "  ‚úì {$tabela}\n";
        }
        
        echo "\nTabelas em Produ√ß√£o (" . count($tabelasProd) . "):\n";
        foreach ($tabelasProd as $tabela) {
            echo "  ‚úì {$tabela}\n";
        }
        
        $faltamEmProd = array_diff($tabelasDev, $tabelasProd);
        $faltamEmDev = array_diff($tabelasProd, $tabelasDev);
        
        if (!empty($faltamEmProd)) {
            echo "\n‚ùå **TABELAS FALTANDO EM PRODU√á√ÉO:**\n";
            foreach ($faltamEmProd as $tabela) {
                echo "  - {$tabela}\n";
            }
        }
        
        if (!empty($faltamEmDev)) {
            echo "\n‚ùå **TABELAS FALTANDO EM DESENVOLVIMENTO:**\n";
            foreach ($faltamEmDev as $tabela) {
                echo "  - {$tabela}\n";
            }
        }
        
        echo "\n";
    }
    
    /**
     * Verifica colunas das tabelas principais
     */
    private function verificarColunasPrincipais()
    {
        echo "üìä **2. VERIFICA√á√ÉO DE COLUNAS PRINCIPAIS**\n";
        echo str_repeat("-", 50) . "\n";
        
        $tabelasPrincipais = [
            'conversas',
            'departamentos', 
            'usuarios',
            'contatos',
            'mensagens',
            'credenciais_serpro_departamento',
            'atendentes_departamento',
            'mensagens_automaticas_departamento'
        ];
        
        foreach ($tabelasPrincipais as $tabela) {
            $this->compararColunas($tabela);
        }
        
        echo "\n";
    }
    
    /**
     * Compara colunas de uma tabela espec√≠fica
     */
    private function compararColunas($tabela)
    {
        try {
            $colunasDev = $this->getColunas($this->dbDev, $tabela);
            $colunasProd = $this->getColunas($this->dbProd, $tabela);
            
            if (empty($colunasDev) && empty($colunasProd)) {
                echo "‚ö†Ô∏è  Tabela '{$tabela}' n√£o existe em nenhum banco\n";
                return;
            }
            
            if (empty($colunasDev)) {
                echo "‚ùå Tabela '{$tabela}' n√£o existe em desenvolvimento\n";
                return;
            }
            
            if (empty($colunasProd)) {
                echo "‚ùå Tabela '{$tabela}' n√£o existe em produ√ß√£o\n";
                return;
            }
            
            $faltamEmProd = array_diff_key($colunasDev, $colunasProd);
            $faltamEmDev = array_diff_key($colunasProd, $colunasDev);
            
            if (!empty($faltamEmProd) || !empty($faltamEmDev)) {
                echo "üìã **Tabela: {$tabela}**\n";
                
                if (!empty($faltamEmProd)) {
                    echo "  ‚ùå Colunas faltando em PRODU√á√ÉO:\n";
                    foreach ($faltamEmProd as $coluna => $tipo) {
                        echo "    - {$coluna} ({$tipo})\n";
                    }
                }
                
                if (!empty($faltamEmDev)) {
                    echo "  ‚ùå Colunas faltando em DESENVOLVIMENTO:\n";
                    foreach ($faltamEmDev as $coluna => $tipo) {
                        echo "    - {$coluna} ({$tipo})\n";
                    }
                }
                echo "\n";
            }
            
        } catch (Exception $e) {
            echo "‚ùå Erro ao verificar tabela '{$tabela}': " . $e->getMessage() . "\n";
        }
    }
    
    /**
     * Verifica dados cr√≠ticos
     */
    private function verificarDadosCriticos()
    {
        echo "üìà **3. VERIFICA√á√ÉO DE DADOS CR√çTICOS**\n";
        echo str_repeat("-", 50) . "\n";
        
        // Verificar departamentos
        $this->verificarDadosTabela('departamentos', 'id, nome, status');
        
        // Verificar usu√°rios
        $this->verificarDadosTabela('usuarios', 'id, nome, email, perfil, status');
        
        // Verificar credenciais
        $this->verificarDadosTabela('credenciais_serpro_departamento', 'id, departamento_id, nome, status');
        
        // Verificar atendentes por departamento
        $this->verificarDadosTabela('atendentes_departamento', 'id, usuario_id, departamento_id, status');
        
        echo "\n";
    }
    
    /**
     * Verifica dados de uma tabela espec√≠fica
     */
    private function verificarDadosTabela($tabela, $campos)
    {
        try {
            $sql = "SELECT {$campos} FROM {$tabela} ORDER BY id";
            
            $dadosDev = $this->dbDev->query($sql)->fetchAll(PDO::FETCH_ASSOC);
            $dadosProd = $this->dbProd->query($sql)->fetchAll(PDO::FETCH_ASSOC);
            
            echo "üìã **{$tabela}**\n";
            echo "  Desenvolvimento: " . count($dadosDev) . " registros\n";
            echo "  Produ√ß√£o: " . count($dadosProd) . " registros\n";
            
            if (count($dadosDev) != count($dadosProd)) {
                echo "  ‚ö†Ô∏è  Diferen√ßa no n√∫mero de registros!\n";
            }
            
            // Mostrar primeiros registros
            if (!empty($dadosDev)) {
                echo "  Primeiros registros (Dev):\n";
                foreach (array_slice($dadosDev, 0, 3) as $registro) {
                    echo "    - " . json_encode($registro) . "\n";
                }
            }
            
            if (!empty($dadosProd)) {
                echo "  Primeiros registros (Prod):\n";
                foreach (array_slice($dadosProd, 0, 3) as $registro) {
                    echo "    - " . json_encode($registro) . "\n";
                }
            }
            
            echo "\n";
            
        } catch (Exception $e) {
            echo "‚ùå Erro ao verificar dados da tabela '{$tabela}': " . $e->getMessage() . "\n";
        }
    }
    
    /**
     * Verifica procedimentos e views
     */
    private function verificarProcedimentosViews()
    {
        echo "üîß **4. VERIFICA√á√ÉO DE PROCEDIMENTOS E VIEWS**\n";
        echo str_repeat("-", 50) . "\n";
        
        // Verificar procedures
        $proceduresDev = $this->getProcedures($this->dbDev);
        $proceduresProd = $this->getProcedures($this->dbProd);
        
        echo "Procedures em Desenvolvimento (" . count($proceduresDev) . "):\n";
        foreach ($proceduresDev as $proc) {
            echo "  ‚úì {$proc}\n";
        }
        
        echo "\nProcedures em Produ√ß√£o (" . count($proceduresProd) . "):\n";
        foreach ($proceduresProd as $proc) {
            echo "  ‚úì {$proc}\n";
        }
        
        // Verificar views
        $viewsDev = $this->getViews($this->dbDev);
        $viewsProd = $this->getViews($this->dbProd);
        
        echo "\nViews em Desenvolvimento (" . count($viewsDev) . "):\n";
        foreach ($viewsDev as $view) {
            echo "  ‚úì {$view}\n";
        }
        
        echo "\nViews em Produ√ß√£o (" . count($viewsProd) . "):\n";
        foreach ($viewsProd as $view) {
            echo "  ‚úì {$view}\n";
        }
        
        echo "\n";
    }
    
    /**
     * Verifica √≠ndices e constraints
     */
    private function verificarIndicesConstraints()
    {
        echo "üîó **5. VERIFICA√á√ÉO DE √çNDICES E CONSTRAINTS**\n";
        echo str_repeat("-", 50) . "\n";
        
        $tabelasPrincipais = ['conversas', 'departamentos', 'usuarios'];
        
        foreach ($tabelasPrincipais as $tabela) {
            $this->verificarIndicesTabela($tabela);
        }
        
        echo "\n";
    }
    
    /**
     * Verifica √≠ndices de uma tabela espec√≠fica
     */
    private function verificarIndicesTabela($tabela)
    {
        try {
            $indicesDev = $this->getIndices($this->dbDev, $tabela);
            $indicesProd = $this->getIndices($this->dbProd, $tabela);
            
            if (!empty($indicesDev) || !empty($indicesProd)) {
                echo "üìã **√çndices da tabela: {$tabela}**\n";
                
                if (!empty($indicesDev)) {
                    echo "  Desenvolvimento:\n";
                    foreach ($indicesDev as $indice) {
                        echo "    ‚úì {$indice}\n";
                    }
                }
                
                if (!empty($indicesProd)) {
                    echo "  Produ√ß√£o:\n";
                    foreach ($indicesProd as $indice) {
                        echo "    ‚úì {$indice}\n";
                    }
                }
                
                echo "\n";
            }
            
        } catch (Exception $e) {
            echo "‚ùå Erro ao verificar √≠ndices da tabela '{$tabela}': " . $e->getMessage() . "\n";
        }
    }
    
    // M√©todos auxiliares
    private function getTabelas($pdo)
    {
        $stmt = $pdo->query("SHOW TABLES");
        return $stmt->fetchAll(PDO::FETCH_COLUMN);
    }
    
    private function getColunas($pdo, $tabela)
    {
        $stmt = $pdo->query("DESCRIBE {$tabela}");
        $colunas = [];
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $colunas[$row['Field']] = $row['Type'];
        }
        return $colunas;
    }
    
    private function getProcedures($pdo)
    {
        $stmt = $pdo->query("SHOW PROCEDURE STATUS WHERE Db = DATABASE()");
        return $stmt->fetchAll(PDO::FETCH_COLUMN, 1);
    }
    
    private function getViews($pdo)
    {
        $stmt = $pdo->query("SHOW FULL TABLES WHERE Table_type = 'VIEW'");
        return $stmt->fetchAll(PDO::FETCH_COLUMN);
    }
    
    private function getIndices($pdo, $tabela)
    {
        $stmt = $pdo->query("SHOW INDEX FROM {$tabela}");
        $indices = [];
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $indices[] = $row['Key_name'] . " (" . $row['Column_name'] . ")";
        }
        return array_unique($indices);
    }
}

// Executar an√°lise
try {
    $analise = new AnaliseBancos();
    $analise->analisarDiferencas();
} catch (Exception $e) {
    echo "‚ùå Erro na an√°lise: " . $e->getMessage() . "\n";
} 